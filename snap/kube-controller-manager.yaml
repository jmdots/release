name: kube-controller-manager
architectures: ['$SNAP_ARCH']
version: '$KUBE_VERSION'
summary: kube-controller-manager
description: kube-controller-manager
grade: stable
confinement: strict

apps:
  daemon:
    command: run-with-config-args kube-controller-manager-wrapper
    daemon: simple
    plugs:
        - network
        - network-bind
        - home
  kube-controller-manager:
    command: kube-controller-manager-wrapper
    plugs:
        - network
        - network-bind
        - home
parts:
  kube-controller-manager:
    plugin: dump
    source: .
    stage-packages:
      - ceph-common:$SNAP_ARCH
    override-build: |
      set -eu
      cp $KUBE_SNAP_BINS/$KUBE_ARCH/kube-controller-manager .
      cp $KUBE_SNAP_ROOT/shared/run-with-config-args .
      cp $KUBE_SNAP_ROOT/kube-controller-manager/kube-controller-manager-wrapper .
      $KUBE_SNAP_ROOT/shared/generate-configure-hook kube-controller-manager

      # By mistake --service-account-private-key-file was marked as deprecated
      # https://github.com/kubernetes/kubernetes/pull/62722
      # Should be fixed soon by https://github.com/kubernetes/kubernetes/pull/60270/files#diff-fc9db90cc6b68d7c3ca838a8512447e9R61
      # But until then, we need to do 1.11 testing
      ensure_arg() {
        type="$1"
        config="$2"
        if ! grep "^config-arg.* $config\$" meta/hooks/configure > /dev/null; then
          if [ "$type" = "bool" ]; then
            echo "config-arg-bool $config" >> meta/hooks/configure
          else
            echo "config-arg $config" >> meta/hooks/configure
          fi
        fi
      }
      ensure_arg string service-account-private-key-file

      snapcraftctl build
